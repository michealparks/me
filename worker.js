!function(){importScripts("ammo.js");const e=new Set,t=new Map,n=new Map,i=new Map,a=new Map,o=new Map,s=new Map,r=new Map;let d,l,c,g,p,u,y,f,b,w,m,h=0,v=0,M=0,V=0,R=0;!async function(){d=await self.Ammo(),l=new d.btTransform,c=new d.btVector3,g=new d.btVector3,p=new d.btVector3,u=new d.btQuaternion;const e=new d.btDefaultCollisionConfiguration,t=new d.btCollisionDispatcher(e),n=new d.btDbvtBroadphase,i=new d.btSequentialImpulseConstraintSolver;y=new d.btDiscreteDynamicsWorld(t,n,i,e),y.setGravity(new d.btVector3(0,-9.8,0)),postMessage({op:"init"})}();const S=(e,t)=>{const{id:a}=e;let o=!1;!1===n.has(a)&&n.set(a,{body:e,others:new Map});const s=n.get(a);return!1===s.others.has(t.id)&&(s.others.set(t.id,t),o=!0),!1===i.has(a)&&i.set(a,{body:e,others:new Map}),i.get(a).others.set(t.id,t),o},C=(e,t,n)=>{!1===e.has(t)&&e.set(t,[]),e.get(t).push(n)},B=(e,n,i)=>{const{transform:a}=e;let o;const s=((e,t,n,i)=>{switch(t){case 0:return c.setValue(n[7],n[8],n[9]),new d.btBoxShape(c);case 2:if(void 0===i)throw Error(e+": vertices is undefined");{const e=new d.btTriangleMesh,t=!0;for(let t=0,n=i.length;t<n;t+=9)c.setValue(i[t+0],i[t+1],i[t+2]),g.setValue(i[t+3],i[t+4],i[t+5]),p.setValue(i[t+6],i[t+7],i[t+8]),e.addTriangle(c,g,p,!0);return new d.btBvhTriangleMeshShape(e,t)}case 1:return new d.btSphereShape(n[7]);default:throw Error("Shape not specified.")}})(e.name,e.shape,a,e.triangles);s.setMargin(0),!0===n&&(o=new d.btVector3(0,0,0),s.calculateLocalInertia(e.mass??0,o)),c.setValue(a[0],a[1],a[2]),u.setValue(a[3],a[4],a[5],a[6]),l.setOrigin(c),l.setRotation(u);const r=new d.btDefaultMotionState(l),y=new d.btRigidBodyConstructionInfo(e.mass??0,r,s,o),f=new d.btRigidBody(y);return f.type=e.type,f.trigger=!1,f.id=e.id,f.name=e.name,f.linkedRigidbodyId=e.linkedRigidbodyId,f.setRestitution(e.restitution??0),f.setFriction(e.friction??0),f.setDamping(e.linearDamping??0,e.angularDamping??0),void 0!==i&&f.setCollisionFlags(f.getCollisionFlags()|i),d.destroy(y),!0===n&&d.destroy(o),t.set(f.id,f),f},I=(e,n,i,a=0)=>{b=t.get(e),b.activate(),!0===i&&(c.setValue(0,0,0),b.setLinearVelocity(c),c.setValue(0,0,0),b.setAngularVelocity(c)),c.setValue(n[a+0],n[a+1],n[a+2]),u.setValue(n[a+3],n[a+4],n[a+5],n[a+6]),l.setOrigin(c),l.setRotation(u),b.setWorldTransform(l),2===b.type&&b.getMotionState()?.setWorldTransform(l)};onmessage=({data:g})=>{switch(g.op){case"update":return(c=>{for(b of(h=performance.now(),M=(h-v)/1e3,v=h,y.stepSimulation(M,40,.016666666666666666),V=0,e))!0===b.isActive()&&(f=b.getMotionState(),f.getWorldTransform(l),w=l.getOrigin(),m=l.getRotation(),R=7*V,c[R+0]=w.x(),c[R+1]=w.y(),c[R+2]=w.z(),c[R+3]=m.x(),c[R+4]=m.y(),c[R+5]=m.z(),c[R+6]=m.w(),void 0!==b.linkedRigidbodyId&&t.get(b.linkedRigidbodyId)?.setMotionState(f)),V+=1;const g=[];(e=>{s.clear(),a.clear(),i.clear();const t=y.getDispatcher(),n=t.getNumManifolds();for(V=0;V<n;V++){const n=t.getManifoldByIndexInternal(V);if(0===n.getNumContacts())continue;const i=d.castObject(n.getBody0(),d.btRigidBody),o=d.castObject(n.getBody1(),d.btRigidBody);let r=!1;const l=4==(4&i.getCollisionFlags()),c=4==(4&o.getCollisionFlags());l||c?(r=S(i,o),r&&!1===c&&(C(s,i.id,o.id),!i.enter||o.name!==i.entity&&"any"!==i.entity||e.push([i.enter,i.id,o.id])),r=S(o,i),r&&!1===l&&(C(s,o.id,i.id),!o.enter||i.name!==o.entity&&"any"!==o.entity||e.push([o.enter,o.id,i.id]))):(r=S(i,o),r&&C(a,i.id,o.id),r=S(o,i),r&&C(a,o.id,i.id))}})(g),(e=>{r.clear(),o.clear();for(const[t,a]of n){const s=i.get(t),{body:d,others:l}=a;for(const[t,n]of l)void 0!==s&&!1!==s.others.has(t)||(l.delete(t),!0===d.trigger?(C(r,d.id,n.id),!d.leave||n.name!==d.entity&&"any"!==d.entity||e.push([d.leave,d.id,n.id])):!1===n.trigger&&C(o,d.id,n.id));0===l.size&&n.delete(t)}})(g),postMessage({op:"update",transforms:c,globalEvents:g,triggerEnter:[...s],collisionStart:[...a],triggerLeave:[...r],collisionEnd:[...o]},[c.buffer])})(g.transforms);case"applyCentralImpulse":return p=g.id,u=g.impulse,b=t.get(p),c.setValue(u.x,u.y,u.z),b.applyCentralImpulse(c),void b.activate();case"applyCentralForce":return((e,n)=>{b=t.get(e),c.setValue(n.x,n.y,n.z),b.applyCentralForce(c),b.activate()})(g.id,g.force);case"teleport":return I(g.id,g.transform,g.clearForces);case"teleportMany":return((e,t,n)=>{V=0;for(const i of e)I(i,t,n,V),V+=7})(g.ids,g.transforms,g.clearForces);case"createRigidbodies":return(t=>{let n,i,a;for(const o of t)switch(o.type){case 0:a=!1,n=1,i=B(o,a,n),y.addRigidBody(i,2,65533);break;case 1:a=0!==(o.mass||0),n=void 0,i=B(o,a,n),e.add(i),y.addRigidBody(i,1,65535);break;case 2:a=!1,n=2,i=B(o,a,n),i.setActivationState(4),y.addRigidBody(i)}})(g.objects)}var p,u}}();
