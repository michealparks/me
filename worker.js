!function(){importScripts("ammo.js");const e=new Set,t=new Map,i=new Map,n=new Map,a=new Map,s=new Map,o=new Map,r=new Map;let d,l,c,g,p,u,y,f,b,w,m,h=0,v=0,M=0,V=0,R=0;!async function(){d=await self.Ammo(),l=new d.btTransform,c=new d.btVector3,g=new d.btVector3,p=new d.btVector3,u=new d.btQuaternion;const e=new d.btDefaultCollisionConfiguration,t=new d.btCollisionDispatcher(e),i=new d.btDbvtBroadphase,n=new d.btSequentialImpulseConstraintSolver;y=new d.btDiscreteDynamicsWorld(t,i,n,e),y.setGravity(new d.btVector3(0,-9.8,0)),postMessage({op:"init"})}();const S=(e,t)=>{const{id:a}=e;let s=!1;!1===i.has(a)&&i.set(a,{body:e,others:new Map});const o=i.get(a);return!1===o.others.has(t.id)&&(o.others.set(t.id,t),s=!0),!1===n.has(a)&&n.set(a,{body:e,others:new Map}),n.get(a).others.set(t.id,t),s},C=(e,t,i)=>{!1===e.has(t)&&e.set(t,[]),e.get(t).push(i)},B=(e,i,n)=>{const{transform:a}=e;let s;const o=((e,t,i,n)=>{switch(t){case 0:return c.setValue(i[7],i[8],i[9]),new d.btBoxShape(c);case 2:if(void 0===n)throw Error(e+": vertices is undefined");{const e=new d.btTriangleMesh,t=!0;for(let t=0,i=n.length;t<i;t+=9)c.setValue(n[t+0],n[t+1],n[t+2]),g.setValue(n[t+3],n[t+4],n[t+5]),p.setValue(n[t+6],n[t+7],n[t+8]),e.addTriangle(c,g,p,!0);return new d.btBvhTriangleMeshShape(e,t)}case 1:return new d.btSphereShape(i[7]);default:throw Error("Shape not specified.")}})(e.name,e.shape,a,e.triangles);o.setMargin(0),!0===i&&(s=new d.btVector3(0,0,0),o.calculateLocalInertia(e.mass??0,s)),c.setValue(a[0],a[1],a[2]),u.setValue(a[3],a[4],a[5],a[6]),l.setOrigin(c),l.setRotation(u);const r=new d.btDefaultMotionState(l),y=new d.btRigidBodyConstructionInfo(e.mass??0,r,o,s),f=new d.btRigidBody(y);return f.type=e.type,f.trigger=!1,f.id=e.id,f.name=e.name,f.linkedRigidbodyId=e.linkedRigidbodyId,f.setRestitution(e.restitution??0),f.setFriction(e.friction??0),f.setDamping(e.linearDamping??0,e.angularDamping??0),void 0!==n&&f.setCollisionFlags(f.getCollisionFlags()|n),d.destroy(y),!0===i&&d.destroy(s),t.set(f.id,f),f},I=(e,i,n,a=0)=>{b=t.get(e),b.activate(),!0===n&&(c.setValue(0,0,0),b.setLinearVelocity(c),c.setValue(0,0,0),b.setAngularVelocity(c)),c.setValue(i[a+0],i[a+1],i[a+2]),u.setValue(i[a+3],i[a+4],i[a+5],i[a+6]),l.setOrigin(c),l.setRotation(u),b.setWorldTransform(l),2===b.type&&b.getMotionState()?.setWorldTransform(l)};onmessage=({data:g})=>{switch(g.op){case"update":return(c=>{for(b of(h=performance.now(),M=(h-v)/1e3,v=h,y.stepSimulation(M,40,.016666666666666666),V=0,e))!0===b.isActive()&&(f=b.getMotionState(),f.getWorldTransform(l),w=l.getOrigin(),m=l.getRotation(),R=7*V,c[R+0]=w.x(),c[R+1]=w.y(),c[R+2]=w.z(),c[R+3]=m.x(),c[R+4]=m.y(),c[R+5]=m.z(),c[R+6]=m.w(),void 0!==b.linkedRigidbodyId&&t.get(b.linkedRigidbodyId)?.setMotionState(f)),V+=1;const g=[];(e=>{o.clear(),a.clear(),n.clear();const t=y.getDispatcher(),i=t.getNumManifolds();for(V=0;V<i;V++){const i=t.getManifoldByIndexInternal(V);if(0===i.getNumContacts())continue;const n=d.castObject(i.getBody0(),d.btRigidBody),s=d.castObject(i.getBody1(),d.btRigidBody);let r=!1;const l=4==(4&n.getCollisionFlags()),c=4==(4&s.getCollisionFlags());l||c?(r=S(n,s),r&&!1===c&&(C(o,n.id,s.id),!n.enter||s.name!==n.entity&&"any"!==n.entity||e.push([n.enter,n.id,s.id])),r=S(s,n),r&&!1===l&&(C(o,s.id,n.id),!s.enter||n.name!==s.entity&&"any"!==s.entity||e.push([s.enter,s.id,n.id]))):(r=S(n,s),r&&C(a,n.id,s.id),r=S(s,n),r&&C(a,s.id,n.id))}})(g),(e=>{r.clear(),s.clear();for(const[t,a]of i){const o=n.get(t),{body:d,others:l}=a;for(const[t,i]of l)void 0!==o&&!1!==o.others.has(t)||(l.delete(t),!0===d.trigger?(C(r,d.id,i.id),!d.leave||i.name!==d.entity&&"any"!==d.entity||e.push([d.leave,d.id,i.id])):!1===i.trigger&&C(s,d.id,i.id));0===l.size&&i.delete(t)}})(g),postMessage({op:"update",transforms:c,globalEvents:g,triggerEnter:[...o],collisionStart:[...a],triggerLeave:[...r],collisionEnd:[...s]},[c.buffer])})(g.transforms);case"applyCentralImpulse":return u=g.id,D=g.impulse,b=t.get(u),c.setValue(D.x,D.y,D.z),b.applyCentralImpulse(c),void b.activate();case"applyCentralForce":return((e,i)=>{b=t.get(e),c.setValue(i.x,i.y,i.z),b.applyCentralForce(c),b.activate()})(g.id,g.force);case"teleport":return I(g.id,g.transform,g.clearForces);case"teleportMany":return((e,t,i)=>{V=0;for(const n of e)I(n,t,i,V),V+=7})(g.ids,g.transforms,g.clearForces);case"createRigidbodies":return(t=>{let i,n,a;for(const s of t)switch(s.type){case 0:a=!1,i=1,n=B(s,a,i),y.addRigidBody(n,2,65533);break;case 1:a=0!==(s.mass||0),i=void 0,n=B(s,a,i),e.add(n),y.addRigidBody(n,1,65535);break;case 2:a=!1,i=2,n=B(s,a,i),n.setActivationState(4),y.addRigidBody(n)}})(g.objects);case"setGravity":return p=g.acceleration,c.setValue(p.x,p.y,p.z),void y.setGravity(c)}var p,u,D}}();
